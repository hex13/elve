<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <style>
        body {
            background: black;
        }
    </style>
</head>
<body>
    <canvas id="game" width="1024" height="1024"></canvas>
    <script type="module">
        const count = 10000;
        const componentsPerVertex = 2;

        import initElve, {ParticleSystem as App} from './pkg/elve.js';

        let wasmPositions, colors;

        initElve().then(engine => {
            console.log("engine", engine);
            const app = new App(count);
            const positions = app.positions();
            const buff = new Float32Array(engine.memory.buffer, positions, count * componentsPerVertex);
            wasmPositions = buff;
            colors = new Float32Array(engine.memory.buffer, app.colors(), count * 4);
            init(app);
        });


        function init(app) {
            function check({shader, program} = {}) {
            const err = gl.getError();
            if (err) console.log("ERR",err);
            if (shader) {
                const info = gl.getShaderInfoLog(shader);
                if (info) console.log(info)
            }
            if (program) {
                const info = gl.getProgramInfoLog(program);
                if (info) console.log(info);
            }
        }
        const shaderSources = {
            VERTEX_SHADER: `
            attribute vec2 aPosition;
            attribute vec4 aColor;
            varying highp vec4 color;
            void main() {
                gl_Position = vec4(aPosition, 0.0, 1.0);
                // gl_PointSize = 2.0 - aColor.a * 2.0 + 2.5;
                float brightness = aColor.r + aColor.g + aColor.b + aColor.b;
                gl_PointSize = 2.0;
                color = aColor;
            }
            `,
            FRAGMENT_SHADER:  `
            varying highp vec4 color;
            void main() {
                gl_FragColor = color;
            }
            `,
        };
        const canvas = document.getElementById('game');
        const gl = canvas.getContext('webgl2', {
            premultipliedAlpha: false, 
            alpha: true,
            antialias: true,
            preserveDrawingBuffer: true,
        });

        const shaders = Object.fromEntries(Object.entries(shaderSources).map(([k, source]) => {
            const shader = gl.createShader(gl[k]);
            check({shader});
            gl.shaderSource(shader, source);
            check({shader});
            gl.compileShader(shader);
            check({shader});
            return [k.split('_')[0].toLowerCase(), shader];
        }));

        gl.enable(gl.BLEND);
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        const program = gl.createProgram();
        check({program});
        gl.attachShader(program, shaders.fragment);
        check({program});
        gl.attachShader(program, shaders.vertex);
        check({program});
        console.log("SHADERS", shaders);
        gl.linkProgram(program);
        check({program});


        const buffer = gl.createBuffer();
        const colorBuffer = gl.createBuffer();
        check({program});
        gl.useProgram(program);
        check({program});


        const velocities = new Float32Array(count * componentsPerVertex);
        const particles =  new Float32Array(count * componentsPerVertex);
        let center;
        function render() {
            const particles = wasmPositions;
            gl.clearColor(0.0, 0.0, 0.0, 0.5);
            gl.clear(gl.COLOR_BUFFER_BIT);


            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, particles, gl.DYNAMIC_DRAW);

            const aPosition = gl.getAttribLocation(program, 'aPosition');
            gl.vertexAttribPointer(aPosition, componentsPerVertex, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(aPosition);


            gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, colors, gl.DYNAMIC_DRAW);

            const aColor = gl.getAttribLocation(program, 'aColor');

            gl.vertexAttribPointer(aColor, 4 /*rgba*/, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(aColor);


            gl.drawArrays(gl.POINTS, 0, count);

        }
        
        let angle = 0.0;
        app.create_explosion();
        (function update() {
            app.update();
            render();
            requestAnimationFrame(update);
        })();

        }



    </script>
</body>
